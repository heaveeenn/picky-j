<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Picky Authentication API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #2980b9;
        }
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        pre { margin: 0; white-space: pre-wrap; }
    </style>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
<div class="container">
    <h1>ğŸ” Picky Authentication API Test</h1>

    <!-- Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h3>1. Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h3>
        <p>ì‹¤ì œ Google ë¡œê·¸ì¸ì„ ìœ„í•´ì„œëŠ” Google One Tapì„ ì‚¬ìš©í•˜ê±°ë‚˜ ì•„ë˜ì— ì§ì ‘ ID Tokenì„ ì…ë ¥í•˜ì„¸ìš”.</p>

        <!-- Google One Tap ë²„íŠ¼ -->
        <div data-callback="handleCredentialResponse"
             data-client_id="89436861621-nkkljkj1to3m7j2dl3v4kde6pja9s5p7.apps.googleusercontent.com"
             id="g_id_onload">
        </div>
        <div class="g_id_signin" data-type="standard"></div>

        <br><br>
        <label>ë˜ëŠ” ì§ì ‘ Google ID Token ì…ë ¥:</label>
        <input id="googleToken" placeholder="Google ID Tokenì„ ì…ë ¥í•˜ì„¸ìš”" type="text">
        <button onclick="testGoogleLogin()">Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
        <div class="response" id="loginResponse"></div>
    </div>

    <!-- ë¦¬í”„ë ˆì‹œ í† í° í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h3>2. ë¦¬í”„ë ˆì‹œ í† í° í…ŒìŠ¤íŠ¸</h3>
        <input id="refreshToken" placeholder="Refresh Tokenì„ ì…ë ¥í•˜ì„¸ìš”" type="text">
        <button onclick="testRefreshToken()">í† í° ê°±ì‹  í…ŒìŠ¤íŠ¸</button>
        <div class="response" id="refreshResponse"></div>
    </div>

    <!-- ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h3>3. ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸</h3>
        <button onclick="testLogout()">ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸</button>
        <div class="response" id="logoutResponse"></div>
    </div>

    <!-- ì €ì¥ëœ í† í° ì •ë³´ -->
    <div class="test-section">
        <h3>4. ì €ì¥ëœ í† í° ì •ë³´</h3>
        <button onclick="showStoredTokens()">ì €ì¥ëœ í† í° ë³´ê¸°</button>
        <button onclick="clearTokens()">í† í° í´ë¦¬ì–´</button>
        <div class="response" id="tokenInfo"></div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8080';

    // Google One Tap ì½œë°± í•¨ìˆ˜
    function handleCredentialResponse(response) {
        console.log("Encoded JWT ID token: " + response.credential);
        document.getElementById('googleToken').value = response.credential;
        testGoogleLogin();
    }

    // Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
    async function testGoogleLogin() {
        const token = document.getElementById('googleToken').value;
        const responseDiv = document.getElementById('loginResponse');

        if (!token) {
            showResponse(responseDiv, { error: 'Google ID Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, false);
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/auth/google/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ idToken: token })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // í† í° ì €ì¥
                localStorage.setItem('accessToken', data.data.accessToken);
                localStorage.setItem('refreshToken', data.data.refreshToken);
                document.getElementById('refreshToken').value = data.data.refreshToken;
            }

            showResponse(responseDiv, data, response.ok);
        } catch (error) {
            showResponse(responseDiv, { error: error.message }, false);
        }
    }

    // ë¦¬í”„ë ˆì‹œ í† í° í…ŒìŠ¤íŠ¸
    async function testRefreshToken() {
        const token = document.getElementById('refreshToken').value || localStorage.getItem('refreshToken');
        const responseDiv = document.getElementById('refreshResponse');

        if (!token) {
            showResponse(responseDiv, { error: 'Refresh Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, false);
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/auth/refresh`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ refreshToken: token })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // ìƒˆ í† í° ì €ì¥
                localStorage.setItem('accessToken', data.data.accessToken);
                localStorage.setItem('refreshToken', data.data.refreshToken);
            }

            showResponse(responseDiv, data, response.ok);
        } catch (error) {
            showResponse(responseDiv, { error: error.message }, false);
        }
    }

    // ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸
    async function testLogout() {
        const responseDiv = document.getElementById('logoutResponse');

        try {
            const response = await fetch(`${API_BASE}/auth/logout`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // ì €ì¥ëœ í† í° ì œê±°
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                document.getElementById('refreshToken').value = '';
            }

            showResponse(responseDiv, data, response.ok);
        } catch (error) {
            showResponse(responseDiv, { error: error.message }, false);
        }
    }

    // ì €ì¥ëœ í† í° ì •ë³´ ë³´ê¸°
    function showStoredTokens() {
        const responseDiv = document.getElementById('tokenInfo');
        const accessToken = localStorage.getItem('accessToken');
        const refreshToken = localStorage.getItem('refreshToken');

        const tokenInfo = {
            accessToken: accessToken ? accessToken.substring(0, 50) + '...' : 'None',
            refreshToken: refreshToken ? refreshToken.substring(0, 50) + '...' : 'None',
            fullAccessToken: accessToken,
            fullRefreshToken: refreshToken
        };

        showResponse(responseDiv, tokenInfo, true);
    }

    // í† í° í´ë¦¬ì–´
    function clearTokens() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        document.getElementById('refreshToken').value = '';
        document.getElementById('googleToken').value = '';
        document.getElementById('tokenInfo').innerHTML = '';
        alert('í† í°ì´ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ì‘ë‹µ í‘œì‹œ í—¬í¼ í•¨ìˆ˜
    function showResponse(element, data, isSuccess) {
        element.className = `response ${isSuccess ? 'success' : 'error'}`;
        element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í† í° í™•ì¸
    window.onload = function() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (refreshToken) {
            document.getElementById('refreshToken').value = refreshToken;
        }
    };
</script>
</body>
</html>